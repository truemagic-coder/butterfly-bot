name: Publish Homebrew Formula

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-homebrew-formula:
    name: Generate stable formula
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Compute release metadata
        id: meta
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          URL="https://github.com/truemagic-coder/butterfly-bot/archive/refs/tags/${TAG}.tar.gz"
          curl -fsSL "$URL" -o source.tar.gz
          SHA256="$(sha256sum source.tar.gz | awk '{print $1}')"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Generate formula
        run: |
          set -euo pipefail
          python3 .github/scripts/generate_homebrew_formula.py \
            --version "${{ steps.meta.outputs.version }}" \
            --url "${{ steps.meta.outputs.url }}" \
            --sha256 "${{ steps.meta.outputs.sha256 }}" \
            --output ./Formula/butterfly-bot.rb

      - name: Commit updated formula
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/butterfly-bot.rb
          if git diff --cached --quiet; then
            echo "No formula change to commit"
            exit 0
          fi
          git commit -m "homebrew: update formula for ${GITHUB_REF_NAME}"
          git push
